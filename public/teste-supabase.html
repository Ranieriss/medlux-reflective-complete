<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Supabase - MEDLUX</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        h1 {
            color: #4CAF50;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #result {
            white-space: pre-wrap;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            border: 1px solid #444;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <h1>üîç Teste de Conex√£o Supabase - MEDLUX Reflective</h1>
    
    <div class="section">
        <h2>Informa√ß√µes do Projeto</h2>
        <p><strong>Projeto correto:</strong> earrnuuvdzawclxsyoxk</p>
        <p><strong>Status:</strong> <span id="status">Aguardando teste...</span></p>
    </div>

    <div class="section">
        <h2>Testes Dispon√≠veis</h2>
        <button onclick="testarConexao()">1. Testar Conex√£o</button>
        <button onclick="contarEquipamentos()">2. Contar Equipamentos</button>
        <button onclick="listarEquipamentos()">3. Listar Todos os Equipamentos</button>
        <button onclick="testarQueryAdmin()">4. Testar Query Admin (como no app)</button>
        <button onclick="limparResultado()">Limpar</button>
    </div>

    <div class="section">
        <h2>Resultado:</h2>
        <div id="result">Clique em um bot√£o acima para executar o teste...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configura√ß√£o Supabase (projeto CORRETO)
        const SUPABASE_URL = 'https://earrnuuvdzawclxsyoxk.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhcnJudXV2ZHphd2NseHN5b3hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMDk3MTQsImV4cCI6MjA4NjY4NTcxNH0.tKLBk3b4CZyT8nhMi610mmwpgMGBJlJAgC9vej_VuQg'
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        const resultDiv = document.getElementById('result')
        const statusSpan = document.getElementById('status')
        
        function log(message, type = 'info') {
            const className = type
            const timestamp = new Date().toLocaleTimeString('pt-BR')
            resultDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`
            resultDiv.scrollTop = resultDiv.scrollHeight
        }
        
        function limparResultado() {
            resultDiv.innerHTML = 'Resultado limpo. Pronto para novos testes...\n'
        }
        
        async function testarConexao() {
            limparResultado()
            log('üîÑ Testando conex√£o com Supabase...', 'info')
            
            try {
                const { data, error } = await supabase
                    .from('equipamentos')
                    .select('count')
                    .limit(1)
                
                if (error) {
                    log('‚ùå Erro de conex√£o: ' + error.message, 'error')
                    statusSpan.textContent = '‚ùå Falha na conex√£o'
                    statusSpan.className = 'error'
                    return
                }
                
                log('‚úÖ Conex√£o estabelecida com sucesso!', 'success')
                statusSpan.textContent = '‚úÖ Conectado'
                statusSpan.className = 'success'
            } catch (error) {
                log('‚ùå Erro fatal: ' + error.message, 'error')
                statusSpan.textContent = '‚ùå Erro fatal'
                statusSpan.className = 'error'
            }
        }
        
        async function contarEquipamentos() {
            log('\nüî¢ Contando equipamentos na tabela...', 'info')
            
            try {
                const { count, error } = await supabase
                    .from('equipamentos')
                    .select('*', { count: 'exact', head: true })
                
                if (error) {
                    log('‚ùå Erro ao contar: ' + error.message, 'error')
                    return
                }
                
                log(`üìä Total de equipamentos: ${count}`, count > 0 ? 'success' : 'warning')
                
                if (count === 0) {
                    log('‚ö†Ô∏è ATEN√á√ÉO: Tabela equipamentos est√° VAZIA!', 'warning')
                    log('   Execute o SQL de inser√ß√£o dos 22 equipamentos.', 'warning')
                } else if (count === 22) {
                    log('‚úÖ PERFEITO! Todos os 22 equipamentos est√£o no banco!', 'success')
                } else {
                    log(`‚ö†Ô∏è ATEN√á√ÉO: Esperado 22, mas h√° ${count} equipamentos!`, 'warning')
                }
            } catch (error) {
                log('‚ùå Erro: ' + error.message, 'error')
            }
        }
        
        async function listarEquipamentos() {
            log('\nüìã Listando todos os equipamentos...', 'info')
            
            try {
                const { data, error } = await supabase
                    .from('equipamentos')
                    .select('*')
                    .order('codigo', { ascending: true })
                
                if (error) {
                    log('‚ùå Erro na query: ' + error.message, 'error')
                    return
                }
                
                if (!data || data.length === 0) {
                    log('‚ö†Ô∏è Nenhum equipamento encontrado!', 'warning')
                    log('   A tabela est√° vazia. Execute o SQL de inser√ß√£o.', 'warning')
                    return
                }
                
                log(`‚úÖ ${data.length} equipamentos encontrados:\n`, 'success')
                
                // Agrupar por tipo
                const porTipo = data.reduce((acc, eq) => {
                    acc[eq.tipo] = (acc[eq.tipo] || 0) + 1
                    return acc
                }, {})
                
                log('üìä Distribui√ß√£o por tipo:', 'info')
                Object.entries(porTipo).forEach(([tipo, count]) => {
                    log(`   - ${tipo}: ${count}`, 'info')
                })
                
                log('\nüìã Lista completa:', 'info')
                data.forEach(eq => {
                    log(`   ${eq.codigo} - ${eq.nome} (${eq.tipo}) - Status: ${eq.status}`, 'info')
                })
                
            } catch (error) {
                log('‚ùå Erro: ' + error.message, 'error')
            }
        }
        
        async function testarQueryAdmin() {
            log('\nüîç Testando query EXATA do componente (Admin)...', 'info')
            
            try {
                // Query exata do equipamentoService.js linha 95-98
                const { data, error } = await supabase
                    .from('equipamentos')
                    .select('*')
                    .order('codigo', { ascending: true })
                
                if (error) {
                    log('‚ùå Erro na query: ' + error.message, 'error')
                    log('   Poss√≠vel problema de RLS (Row Level Security)', 'warning')
                    return
                }
                
                log(`üì¶ Query retornou: ${data?.length || 0} equipamentos`, data?.length > 0 ? 'success' : 'error')
                
                if (data && data.length > 0) {
                    log('‚úÖ SUCESSO! A query funciona corretamente!', 'success')
                    log('\n‚ö†Ô∏è SE O APP AINDA MOSTRA ERRO, O PROBLEMA √â:', 'warning')
                    log('   1. Cache do navegador (Ctrl+F5 para limpar)', 'warning')
                    log('   2. Deploy do Vercel n√£o sincronizado (aguardar 2-3 min)', 'warning')
                    log('   3. C√≥digo antigo ainda em cache', 'warning')
                    log('\nüí° SOLU√á√ÉO:', 'info')
                    log('   - Abra o app em modo an√¥nimo (Ctrl+Shift+N)', 'info')
                    log('   - Ou limpe todo o cache do navegador', 'info')
                    log('   - Ou aguarde alguns minutos para o Vercel atualizar', 'info')
                    
                    log('\nüìã Primeiros 5 equipamentos retornados:', 'info')
                    data.slice(0, 5).forEach(eq => {
                        log(`   ${eq.codigo} - ${eq.nome}`, 'info')
                    })
                } else {
                    log('‚ùå Query retornou VAZIA mesmo com dados no banco!', 'error')
                    log('   Isso indica problema de RLS (Row Level Security)', 'error')
                    log('\nüí° SOLU√á√ÉO:', 'info')
                    log('   No Supabase Dashboard ‚Üí Authentication ‚Üí Policies', 'info')
                    log('   Adicionar pol√≠tica para permitir SELECT p√∫blico na tabela equipamentos', 'info')
                }
                
            } catch (error) {
                log('‚ùå Erro: ' + error.message, 'error')
            }
        }
        
        // Testar conex√£o automaticamente ao carregar
        window.addEventListener('load', () => {
            setTimeout(testarConexao, 500)
        })
    </script>
</body>
</html>
