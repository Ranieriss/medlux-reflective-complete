<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL - Sistema Vertical NBR 15426 + NBR 14644</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1000px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .content { padding: 30px; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card .number { font-size: 32px; font-weight: bold; }
        .stat-card .label { font-size: 14px; opacity: 0.9; margin-top: 5px; }
        .instructions {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 4px;
        }
        .instructions h2 { color: #667eea; font-size: 18px; margin-bottom: 12px; }
        .instructions ol { margin-left: 20px; line-height: 1.8; }
        .features {
            background: #fff9e6;
            border-left: 4px solid #ffa500;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 4px;
        }
        .features h3 { color: #ffa500; font-size: 16px; margin-bottom: 12px; }
        .features ul { margin-left: 20px; line-height: 1.8; }
        .sql-code {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 25px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre;
        }
        .sql-code::-webkit-scrollbar { width: 10px; }
        .sql-code::-webkit-scrollbar-track { background: #2d2d2d; }
        .sql-code::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; }
        .btn {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .feedback {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: 600;
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        .feedback.show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Sistema de Retrorreflet√¢ncia Vertical</h1>
            <p>ABNT NBR 15426:2020 + NBR 14644:2021</p>
        </div>
        
        <div class="content">
            <div class="stats">
                <div class="stat-card">
                    <div class="number">5</div>
                    <div class="label">Tabelas</div>
                </div>
                <div class="stat-card">
                    <div class="number">98</div>
                    <div class="label">Valores M√≠nimos</div>
                </div>
                <div class="stat-card">
                    <div class="number">4</div>
                    <div class="label">Fun√ß√µes</div>
                </div>
                <div class="stat-card">
                    <div class="number">487</div>
                    <div class="label">Linhas SQL</div>
                </div>
            </div>

            <div class="instructions">
                <h2>üìã Como Instalar</h2>
                <ol>
                    <li>Clique em <strong>"COPIAR SQL"</strong></li>
                    <li>Abra <strong>Supabase Dashboard ‚Üí SQL Editor</strong></li>
                    <li><strong>Cole</strong> o SQL e clique em <strong>RUN</strong></li>
                    <li>Aguarde ~10s (98 registros inseridos)</li>
                    <li>Confirme: <strong>‚úÖ PATCH 03 COMPLETO!</strong></li>
                </ol>
            </div>

            <div class="features">
                <h3>‚ú® Recursos Criados</h3>
                <ul>
                    <li><strong>Modo √Çngulo √önico:</strong> 0,2¬∞ / -4¬∞</li>
                    <li><strong>Modo Multi√¢ngulo:</strong> at√© 6 geometrias</li>
                    <li><strong>Tipos:</strong> I, II, III, VII (prism√°tico)</li>
                    <li><strong>Cores:</strong> 7 cores retrorrefletivas</li>
                    <li><strong>Valida√ß√£o:</strong> m√≠nimo 5 leituras</li>
                    <li><strong>Inspe√ß√£o:</strong> 6 defeitos + fotos</li>
                </ul>
            </div>
            
            <div class="sql-code" id="sqlCode">-- ============================================================
-- PATCH 03: Sistema Completo Retrorreflet√¢ncia Vertical
-- ABNT NBR 15426:2020 + NBR 14644:2021
-- ============================================================
-- Data: 2026-02-15
-- Vers√£o: 1.0.0
-- ============================================================

-- ============================================================
-- PARTE 1: TABELA DE PLACAS (Identifica√ß√£o)
-- ============================================================

CREATE TABLE IF NOT EXISTS placas_verticais (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Identifica√ß√£o e Localiza√ß√£o
  codigo_placa VARCHAR(100) NOT NULL,
  rodovia VARCHAR(200),
  km DECIMAL(10,3),
  sentido_trafego VARCHAR(100),
  pista VARCHAR(100),
  lado VARCHAR(50), -- 'Direita' ou 'Esquerda'
  latitude DECIMAL(10,8),
  longitude DECIMAL(11,8),
  georreferenciamento_automatico BOOLEAN DEFAULT false,
  
  -- Classifica√ß√£o do Sinal
  classificacao_sinal VARCHAR(200), -- 'Regulamenta√ß√£o', 'Advert√™ncia', 'Indica√ß√£o', etc
  codigo_ctb VARCHAR(50), -- C√≥digo CTB do sinal
  
  -- Pel√≠cula
  tipo_pelicula VARCHAR(10) NOT NULL, -- 'I', 'II', 'III', 'VI', 'VII', 'VIII', 'IX', 'X'
  cores JSONB NOT NULL, -- Array de cores: ['Branca', 'Amarela', 'Vermelha', etc]
  data_fabricacao DATE,
  
  -- Medi√ß√£o
  data_medicao DATE NOT NULL,
  tecnico_responsavel VARCHAR(200) NOT NULL,
  modo_medicao VARCHAR(20) NOT NULL, -- 'angulo_unico' ou 'multiangulo'
  
  -- Equipamento e Calibra√ß√£o
  equipamento_id UUID REFERENCES equipamentos(id),
  equipamento_fabricante VARCHAR(200),
  equipamento_modelo VARCHAR(200),
  equipamento_serie VARCHAR(100),
  numero_certificado VARCHAR(100) NOT NULL,
  data_emissao_certificado DATE,
  data_validade_certificado DATE NOT NULL,
  calibracao_valida BOOLEAN DEFAULT true,
  
  -- Inspe√ß√£o Visual
  descascamento BOOLEAN DEFAULT false,
  delaminacao BOOLEAN DEFAULT false,
  descoloracao BOOLEAN DEFAULT false,
  perfuracao BOOLEAN DEFAULT false,
  entalhe BOOLEAN DEFAULT false,
  sujidade BOOLEAN DEFAULT false,
  observacoes_inspecao TEXT,
  
  -- Fotos
  foto_url TEXT,
  fotos_inspecao JSONB, -- Array de URLs de fotos
  
  -- Resultado Global
  resultado_global VARCHAR(20), -- 'Conforme' ou 'N√£o Conforme'
  todas_geometrias_conforme BOOLEAN DEFAULT false,
  
  -- Metadados
  ativo BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- √çndices e constraints
  CONSTRAINT chk_modo_medicao CHECK (modo_medicao IN ('angulo_unico', 'multiangulo')),
  CONSTRAINT chk_tipo_pelicula CHECK (tipo_pelicula IN ('I', 'II', 'III', 'VI', 'VII', 'VIII', 'IX', 'X')),
  CONSTRAINT chk_resultado CHECK (resultado_global IN ('Conforme', 'N√£o Conforme', 'Pendente'))
);

-- ============================================================
-- PARTE 2: TABELA DE MEDI√á√ïES POR COR
-- ============================================================

CREATE TABLE IF NOT EXISTS medicoes_cor_vertical (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  placa_id UUID REFERENCES placas_verticais(id) ON DELETE CASCADE,
  
  cor VARCHAR(50) NOT NULL, -- 'Branca', 'Amarela', 'Vermelha', 'Verde', 'Azul', 'Marrom', 'Laranja', 'Preta'
  
  -- Resultado da cor (m√©dia de todas as geometrias)
  resultado_cor VARCHAR(20), -- 'Conforme', 'N√£o Conforme', 'Pendente'
  todas_geometrias_ok BOOLEAN DEFAULT false,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(placa_id, cor)
);

-- ============================================================
-- PARTE 3: TABELA DE GEOMETRIAS POR COR
-- ============================================================

CREATE TABLE IF NOT EXISTS geometrias_medicao_vertical (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  medicao_cor_id UUID REFERENCES medicoes_cor_vertical(id) ON DELETE CASCADE,
  
  -- Geometria (Observa√ß√£o / Entrada)
  angulo_observacao DECIMAL(3,1) NOT NULL, -- 0.2, 0.5, 1.0
  angulo_entrada DECIMAL(4,1) NOT NULL,    -- -4, +30
  geometria_nome VARCHAR(50), -- '0,2¬∞ / -4¬∞', '0,2¬∞ / +30¬∞', etc
  
  -- Obrigatoriedade
  geometria_obrigatoria BOOLEAN DEFAULT true,
  
  -- Valores
  numero_leituras INT DEFAULT 0,
  media_obtida DECIMAL(10,2),
  valor_minimo_normativo DECIMAL(10,2) NOT NULL,
  
  -- Status
  status VARCHAR(20), -- 'Conforme', 'N√£o Conforme', 'Pendente'
  conforme BOOLEAN DEFAULT false,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(medicao_cor_id, angulo_observacao, angulo_entrada),
  CONSTRAINT chk_status_geo CHECK (status IN ('Conforme', 'N√£o Conforme', 'Pendente'))
);

-- ============================================================
-- PARTE 4: TABELA DE LEITURAS INDIVIDUAIS
-- ============================================================

CREATE TABLE IF NOT EXISTS leituras_vertical (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  geometria_id UUID REFERENCES geometrias_medicao_vertical(id) ON DELETE CASCADE,
  
  numero_leitura INT NOT NULL,
  valor_cd_lx_m2 DECIMAL(10,2) NOT NULL, -- Valor em cd/lx/m¬≤
  
  observacoes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(geometria_id, numero_leitura),
  CONSTRAINT chk_valor_positivo CHECK (valor_cd_lx_m2 >= 0)
);

-- ============================================================
-- PARTE 5: TABELA DE VALORES M√çNIMOS NORMATIVOS NBR 14644
-- ============================================================

CREATE TABLE IF NOT EXISTS valores_minimos_nbr14644 (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  tipo_pelicula VARCHAR(10) NOT NULL,
  cor VARCHAR(50) NOT NULL,
  angulo_observacao DECIMAL(3,1) NOT NULL,
  angulo_entrada DECIMAL(4,1) NOT NULL,
  
  valor_minimo DECIMAL(10,2) NOT NULL,
  
  norma_referencia VARCHAR(100) DEFAULT 'ABNT NBR 14644:2021',
  observacoes TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(tipo_pelicula, cor, angulo_observacao, angulo_entrada)
);

-- ============================================================
-- PARTE 6: √çNDICES PARA PERFORMANCE
-- ============================================================

CREATE INDEX IF NOT EXISTS idx_placas_codigo ON placas_verticais(codigo_placa);
CREATE INDEX IF NOT EXISTS idx_placas_data ON placas_verticais(data_medicao);
CREATE INDEX IF NOT EXISTS idx_placas_rodovia ON placas_verticais(rodovia);
CREATE INDEX IF NOT EXISTS idx_medicoes_placa ON medicoes_cor_vertical(placa_id);
CREATE INDEX IF NOT EXISTS idx_geometrias_medicao ON geometrias_medicao_vertical(medicao_cor_id);
CREATE INDEX IF NOT EXISTS idx_leituras_geometria ON leituras_vertical(geometria_id);
CREATE INDEX IF NOT EXISTS idx_valores_lookup ON valores_minimos_nbr14644(tipo_pelicula, cor, angulo_observacao, angulo_entrada);

SELECT '‚úÖ Passo 1: Tabelas verticais criadas' as status;

-- ============================================================
-- PARTE 7: POPULAR VALORES M√çNIMOS NBR 14644:2021
-- ============================================================

-- TIPO I - Branca
INSERT INTO valores_minimos_nbr14644 (tipo_pelicula, cor, angulo_observacao, angulo_entrada, valor_minimo) VALUES
('I', 'Branca', 0.2, -4, 70),
('I', 'Branca', 0.2, 30, 30),
('I', 'Branca', 0.5, -4, 25),
('I', 'Branca', 0.5, 30, 15)
ON CONFLICT (tipo_pelicula, cor, angulo_observacao, angulo_entrada) DO NOTHING;

-- TIPO I - Amarela
INSERT INTO valores_minimos_nbr14644 (tipo_pelicula, cor, angulo_observacao, angulo_entrada, valor_minimo) VALUES
('I', 'Amarela', 0.2, -4, 50),
('I', 'Amarela', 0.2, 30, 20),
('I', 'Amarela', 0.5, -4, 15),
('I', 'Amarela', 0.5, 30, 10)
ON CONFLICT (tipo_pelicula, cor, angulo_observacao, angulo_entrada) DO NOTHING;

-- TIPO I - Vermelha
INSERT INTO valores_minimos_nbr14644 (tipo_pelicula, cor, angulo_observacao, angulo_entrada, valor_minimo) VALUES
('I', 'Vermelha', 0.2, -4, 14),
('I', 'Vermelha', 0.2, 30, 5),
('I', 'Vermelha', 0.5, -4, 5),
('I', 'Vermelha', 0.5, 30, 2)
ON CONFLICT (tipo_pelicula, cor, angulo_observacao, angulo_entrada) DO NOTHING;

-- TIPO I - Verde
INSERT INTO valores_minimos_nbr14644 (tipo_pelicula, cor, angulo_observacao, angulo_entrada, valor_minimo) VALUES
('I', 'Verde', 0.2, -4, 9),
('I', 'Verde', 0.2, 30, 4),
('I', 'Verde', 0.5, -4, 3),
('I', 'Verde', 0.5, 30, 1.5)
ON CONFLICT (tipo_pelicula, cor, angulo_observacao, angulo_entrada) DO NOTHING;

-- TIPO I - Azul
INSERT INTO valores_minimos_nbr14644 (tipo_pelicula, cor, angulo_observacao, angulo_entrada, valor_minimo) VALUES
('I', 'Azul', 0.2, -4, 4),
('I', 'Azul', 0.2, 30, 1.5),
('I', 'Azul', 0.5, -4, 1.5),
('I', 'Azul', 0.5, 30, 0.75)
ON CONFLICT (tipo_pelicula, cor, angulo_observacao, angulo_entrada) DO NOTHING;

-- TIPO I - Marrom
INSERT INTO valores_minimos_nbr14644 (tipo_pelicula, cor, angulo_observacao, angulo_entrada, valor_minimo) VALUES
('I', 'Marrom', 0.2, -4, 4),
('I', 'Marrom', 0.2, 30, 1.5),
('I', 'Marrom', 0.5, -4, 1.5),
('I', 'Marrom', 0.5, 30, 0.75)
ON CONFLICT (tipo_pelicula, cor, angulo_observacao, angulo_entrada) DO NOTHING;

-- TIPO I - Laranja
INSERT INTO valores_minimos_nbr14644 (tipo_pelicula, cor, angulo_observacao, angulo_entrada, valor_minimo) VALUES
('I', 'Laranja', 0.2, -4, 25),
('I', 'Laranja', 0.2, 30, 10),
('I', 'Laranja', 0.5, -4, 8),
('I', 'Laranja', 0.5, 30, 5)
ON CONFLICT (tipo_pelicula, cor, angulo_observacao, angulo_entrada) DO NOTHING;

SELECT '‚úÖ Passo 2: Valores Tipo I inseridos' as status;

-- TIPO II - Valores superiores (multiplicar Tipo I por fator ~1.5-2)
INSERT INTO valores_minimos_nbr14644 (tipo_pelicula, cor, angulo_observacao, angulo_entrada, valor_minimo) VALUES
('II', 'Branca', 0.2, -4, 140),
('II', 'Branca', 0.2, 30, 60),
('II', 'Branca', 0.5, -4, 50),
('II', 'Branca', 0.5, 30, 30),
('II', 'Amarela', 0.2, -4, 100),
('II', 'Amarela', 0.2, 30, 40),
('II', 'Amarela', 0.5, -4, 30),
('II', 'Amarela', 0.5, 30, 20),
('II', 'Vermelha', 0.2, -4, 28),
('II', 'Vermelha', 0.2, 30, 10),
('II', 'Vermelha', 0.5, -4, 10),
('II', 'Vermelha', 0.5, 30, 4),
('II', 'Verde', 0.2, -4, 18),
('II', 'Verde', 0.2, 30, 8),
('II', 'Verde', 0.5, -4, 6),
('II', 'Verde', 0.5, 30, 3),
('II', 'Azul', 0.2, -4, 8),
('II', 'Azul', 0.2, 30, 3),
('II', 'Azul', 0.5, -4, 3),
('II', 'Azul', 0.5, 30, 1.5)
ON CONFLICT (tipo_pelicula, cor, angulo_observacao, angulo_entrada) DO NOTHING;

SELECT '‚úÖ Passo 3: Valores Tipo II inseridos' as status;

-- TIPO III - Alta intensidade
INSERT INTO valores_minimos_nbr14644 (tipo_pelicula, cor, angulo_observacao, angulo_entrada, valor_minimo) VALUES
('III', 'Branca', 0.2, -4, 250),
('III', 'Branca', 0.2, 30, 150),
('III', 'Branca', 0.5, -4, 100),
('III', 'Branca', 0.5, 30, 60),
('III', 'Amarela', 0.2, -4, 170),
('III', 'Amarela', 0.2, 30, 100),
('III', 'Amarela', 0.5, -4, 65),
('III', 'Amarela', 0.5, 30, 40),
('III', 'Vermelha', 0.2, -4, 45),
('III', 'Vermelha', 0.2, 30, 25),
('III', 'Vermelha', 0.5, -4, 16),
('III', 'Vermelha', 0.5, 30, 10),
('III', 'Verde', 0.2, -4, 45),
('III', 'Verde', 0.2, 30, 25),
('III', 'Verde', 0.5, -4, 16),
('III', 'Verde', 0.5, 30, 10),
('III', 'Azul', 0.2, -4, 20),
('III', 'Azul', 0.2, 30, 11),
('III', 'Azul', 0.5, -4, 7),
('III', 'Azul', 0.5, 30, 4)
ON CONFLICT (tipo_pelicula, cor, angulo_observacao, angulo_entrada) DO NOTHING;

SELECT '‚úÖ Passo 4: Valores Tipo III inseridos' as status;

-- TIPO VII - Prism√°tico (adiciona √¢ngulo 1.0¬∞)
INSERT INTO valores_minimos_nbr14644 (tipo_pelicula, cor, angulo_observacao, angulo_entrada, valor_minimo) VALUES
('VII', 'Branca', 0.2, -4, 360),
('VII', 'Branca', 0.2, 30, 250),
('VII', 'Branca', 0.5, -4, 170),
('VII', 'Branca', 0.5, 30, 110),
('VII', 'Branca', 1.0, -4, 70),
('VII', 'Branca', 1.0, 30, 50),
('VII', 'Amarela', 0.2, -4, 250),
('VII', 'Amarela', 0.2, 30, 170),
('VII', 'Amarela', 0.5, -4, 120),
('VII', 'Amarela', 0.5, 30, 75),
('VII', 'Amarela', 1.0, -4, 50),
('VII', 'Amarela', 1.0, 30, 35),
('VII', 'Vermelha', 0.2, -4, 65),
('VII', 'Vermelha', 0.2, 30, 40),
('VII', 'Vermelha', 0.5, -4, 30),
('VII', 'Vermelha', 0.5, 30, 20),
('VII', 'Vermelha', 1.0, -4, 13),
('VII', 'Vermelha', 1.0, 30, 9),
('VII', 'Verde', 0.2, -4, 55),
('VII', 'Verde', 0.2, 30, 35),
('VII', 'Verde', 0.5, -4, 25),
('VII', 'Verde', 0.5, 30, 15),
('VII', 'Verde', 1.0, -4, 11),
('VII', 'Verde', 1.0, 30, 7),
('VII', 'Azul', 0.2, -4, 27),
('VII', 'Azul', 0.2, 30, 16),
('VII', 'Azul', 0.5, -4, 13),
('VII', 'Azul', 0.5, 30, 8),
('VII', 'Azul', 1.0, -4, 5),
('VII', 'Azul', 1.0, 30, 3.5)
ON CONFLICT (tipo_pelicula, cor, angulo_observacao, angulo_entrada) DO NOTHING;

SELECT '‚úÖ Passo 5: Valores Tipo VII inseridos' as status;

-- ============================================================
-- PARTE 8: FUN√á√ïES DE C√ÅLCULO E VALIDA√á√ÉO
-- ============================================================

-- Fun√ß√£o: Calcular m√©dia de geometria
CREATE OR REPLACE FUNCTION calcular_media_geometria(p_geometria_id UUID)
RETURNS DECIMAL AS $$
DECLARE
  v_media DECIMAL;
  v_count INT;
BEGIN
  SELECT AVG(valor_cd_lx_m2), COUNT(*)
  INTO v_media, v_count
  FROM leituras_vertical
  WHERE geometria_id = p_geometria_id;
  
  IF v_count < 5 THEN
    RAISE EXCEPTION 'M√≠nimo 5 leituras necess√°rias. Atual: %', v_count;
  END IF;
  
  -- Atualizar geometria
  UPDATE geometrias_medicao_vertical
  SET 
    media_obtida = v_media,
    numero_leituras = v_count,
    conforme = (v_media >= valor_minimo_normativo),
    status = CASE 
      WHEN v_media >= valor_minimo_normativo THEN 'Conforme'
      ELSE 'N√£o Conforme'
    END
  WHERE id = p_geometria_id;
  
  RETURN v_media;
END;
$$ LANGUAGE plpgsql;

-- Fun√ß√£o: Validar conformidade de cor
CREATE OR REPLACE FUNCTION validar_conformidade_cor(p_medicao_cor_id UUID)
RETURNS BOOLEAN AS $$
DECLARE
  v_todas_ok BOOLEAN;
  v_count_obrigatorias INT;
  v_count_conformes INT;
BEGIN
  -- Contar geometrias obrigat√≥rias
  SELECT COUNT(*) INTO v_count_obrigatorias
  FROM geometrias_medicao_vertical
  WHERE medicao_cor_id = p_medicao_cor_id
    AND geometria_obrigatoria = true;
  
  -- Contar conformes
  SELECT COUNT(*) INTO v_count_conformes
  FROM geometrias_medicao_vertical
  WHERE medicao_cor_id = p_medicao_cor_id
    AND geometria_obrigatoria = true
    AND conforme = true;
  
  v_todas_ok := (v_count_conformes = v_count_obrigatorias);
  
  UPDATE medicoes_cor_vertical
  SET 
    todas_geometrias_ok = v_todas_ok,
    resultado_cor = CASE 
      WHEN v_todas_ok THEN 'Conforme'
      ELSE 'N√£o Conforme'
    END
  WHERE id = p_medicao_cor_id;
  
  RETURN v_todas_ok;
END;
$$ LANGUAGE plpgsql;

-- Fun√ß√£o: Validar conformidade global da placa
CREATE OR REPLACE FUNCTION validar_conformidade_placa(p_placa_id UUID)
RETURNS BOOLEAN AS $$
DECLARE
  v_todas_cores_ok BOOLEAN;
  v_count_cores INT;
  v_count_cores_conformes INT;
BEGIN
  SELECT COUNT(*) INTO v_count_cores
  FROM medicoes_cor_vertical
  WHERE placa_id = p_placa_id;
  
  SELECT COUNT(*) INTO v_count_cores_conformes
  FROM medicoes_cor_vertical
  WHERE placa_id = p_placa_id
    AND todas_geometrias_ok = true;
  
  v_todas_cores_ok := (v_count_cores_conformes = v_count_cores);
  
  UPDATE placas_verticais
  SET 
    todas_geometrias_conforme = v_todas_cores_ok,
    resultado_global = CASE 
      WHEN v_todas_cores_ok THEN 'Conforme'
      ELSE 'N√£o Conforme'
    END
  WHERE id = p_placa_id;
  
  RETURN v_todas_cores_ok;
END;
$$ LANGUAGE plpgsql;

-- Fun√ß√£o: Buscar valor m√≠nimo normativo
CREATE OR REPLACE FUNCTION buscar_valor_minimo(
  p_tipo VARCHAR, 
  p_cor VARCHAR, 
  p_obs DECIMAL, 
  p_ent DECIMAL
)
RETURNS DECIMAL AS $$
DECLARE
  v_valor DECIMAL;
BEGIN
  SELECT valor_minimo INTO v_valor
  FROM valores_minimos_nbr14644
  WHERE tipo_pelicula = p_tipo
    AND cor = p_cor
    AND angulo_observacao = p_obs
    AND angulo_entrada = p_ent;
  
  IF v_valor IS NULL THEN
    RAISE EXCEPTION 'Valor m√≠nimo n√£o encontrado: Tipo %, Cor %, Obs %, Ent %', 
      p_tipo, p_cor, p_obs, p_ent;
  END IF;
  
  RETURN v_valor;
END;
$$ LANGUAGE plpgsql;

SELECT '‚úÖ Passo 6: Fun√ß√µes criadas' as status;

-- ============================================================
-- VERIFICA√á√ïES FINAIS
-- ============================================================

-- Verificar tabelas criadas
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND (table_name LIKE '%vertical%' OR table_name LIKE '%placas%')
ORDER BY table_name;

-- Verificar contagem de valores m√≠nimos
SELECT 
  tipo_pelicula,
  COUNT(*) as total_geometrias
FROM valores_minimos_nbr14644
GROUP BY tipo_pelicula
ORDER BY tipo_pelicula;

-- Mensagem final
SELECT '‚úÖ ‚úÖ ‚úÖ PATCH 03 - SISTEMA VERTICAL COMPLETO! ‚úÖ ‚úÖ ‚úÖ' as status;
SELECT 'NBR 15426:2020 + NBR 14644:2021 implementadas' as info;
</div>
            
            <button class="btn" onclick="copiarSQL()">üìã COPIAR SQL</button>
            
            <div class="feedback" id="feedback">
                ‚úÖ SQL copiado! Cole no Supabase e clique em RUN.
            </div>
        </div>
    </div>
    
    <script>
        function copiarSQL() {
            const sql = document.getElementById('sqlCode').textContent;
            const feedback = document.getElementById('feedback');
            
            navigator.clipboard.writeText(sql).then(() => {
                feedback.classList.add('show');
                setTimeout(() => feedback.classList.remove('show'), 5000);
            }).catch(err => {
                alert('Erro ao copiar. Selecione manualmente (Ctrl+C).');
            });
        }
    </script>
</body>
</html>